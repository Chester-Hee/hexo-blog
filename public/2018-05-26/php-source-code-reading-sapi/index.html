<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="code farmer."><title>PHP源码阅读-SAPI | 追赶日落日出</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?66bdd0a984d281716c78a567d1f39e67";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">首页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/PHP/">PHP</a></div><div class="post-time">2018-05-26</div></div></div><div class="container post-header"><h1>PHP源码阅读-SAPI</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#源码的目录结构"><span class="toc-number">1.</span> <span class="toc-text">源码的目录结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php架构图"><span class="toc-number">2.</span> <span class="toc-text">php架构图</span></a></li></ol></details></div><div class="container post-content"><p>开始之前，先克隆一份源代码：</p>
<p>GitHub下载-&gt;<a href="https://github.com/helingfeng/php-src" target="_blank" rel="noopener">https://github.com/helingfeng/php-src</a></p>
<h4 id="源码的目录结构"><a href="#源码的目录结构" class="headerlink" title="源码的目录结构"></a>源码的目录结构</h4><p><img src="/images/pasted-8.png" alt="upload successful"></p>
<ul>
<li><p>root根目录下，包含项目的说明文件以及设计方案，大部分文件是必读的。</p>
</li>
<li><p>build顾名思义，放置一些和源码编译相关的文件，比如编译前脚本配置、环境监测等。</p>
</li>
<li><p>ext官方扩展，包含了绝大数PHP函数的定义和实现，包括date、pdo、ftp、curl等。</p>
</li>
</ul>
<p><img src="/images/pasted-9.png" alt="upload successful"></p>
<ul>
<li><p>main 放置PHP核心文件，主要实现PHP的基础设施，这里和Zend engine不一样，Zend engine主要完成最核心的语言运行环境。</p>
</li>
<li><p>Zend 放置Zend engine实现文件，包含脚本语法解析，扩展机制的实现等。</p>
</li>
<li><p>pear PHP的扩展与应用仓库</p>
</li>
<li><p>sapi 包含多种服务器的抽象层代码，例如apache的mod_php、cgi、fcgi以及fpm等接口。</p>
</li>
<li><p>TSRM（Thread Safe Resource Manager） php的线程安全是构建在TSRM库之上的。</p>
</li>
<li><p>tests php的测试脚本集合，包含各个模块功能的测试文件。</p>
</li>
<li><p>win32 包含windows平台下的相关实现，比如socket的实现在windows与*Nix平台就不太相同，同时包含了在windows下编译php的相关脚本。</p>
</li>
</ul>
<h4 id="php架构图"><a href="#php架构图" class="headerlink" title="php架构图"></a>php架构图</h4><p><img src="/images/pasted-10.png" alt="upload successful"></p>
<p>从架构图中，很清楚看出SAPI（Server Application Programming Interface）应用编程接口，是非常重要的东东。</p>
<p>今天，拿最简单的CGI接口来学习SAPI。</p>
<blockquote>
<p>先百度百科一下什么是CGI：Common Gateway Interface 是WWW技术中最重要的技术之一，有着不可替代的重要地位。CGI是外部应用程序（CGI程序）与Web服务器之间的接口标准，是在CGI程序和Web服务器之间传递信息的规程。CGI规范允许Web服务器执行外部程序，并将它们的输出发送给Web浏览器，CGI将Web的一组简单的静态超媒体文档变成一个完整的新的交互式媒体。</p>
</blockquote>
<p><strong>脚本执行的开始都是以SAPI接口实现开始的。只是不同的SAPI接口实现会完成他们特定的工作， 例如Apache的mod_php SAPI实现需要初始化从Apache获取的一些信息，在输出内容是将内容返回给Apache， 其他的SAPI实现也类似。</strong></p>
<p>以CGI为例了解一下源码结构：</p>
<p><img src="/images/pasted-12.png" alt="upload successful"></p>
<p>cgi_main.c</p>
<p>定义SAPI：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/* &#123;&#123;&#123; sapi_module_struct cgi_sapi_module</span><br><span class="line"> */</span><br><span class="line">static sapi_module_struct cgi_sapi_module = &#123;</span><br><span class="line">    &quot;cgi-fcgi&quot;,                        /* name */</span><br><span class="line">    &quot;CGI/FastCGI&quot;,                    /* pretty name */</span><br><span class="line"></span><br><span class="line">    php_cgi_startup,                /* startup */</span><br><span class="line">    php_module_shutdown_wrapper,    /* shutdown */</span><br><span class="line"></span><br><span class="line">    sapi_cgi_activate,                /* activate */</span><br><span class="line">    sapi_cgi_deactivate,            /* deactivate */</span><br><span class="line"></span><br><span class="line">    sapi_cgi_ub_write,                /* unbuffered write */</span><br><span class="line">    sapi_cgi_flush,                    /* flush */</span><br><span class="line">    NULL,                            /* get uid */</span><br><span class="line">    sapi_cgi_getenv,                /* getenv */</span><br><span class="line"></span><br><span class="line">    php_error,                        /* error handler */</span><br><span class="line"></span><br><span class="line">    NULL,                            /* header handler */</span><br><span class="line">    sapi_cgi_send_headers,            /* send headers handler */</span><br><span class="line">    NULL,                            /* send header handler */</span><br><span class="line"></span><br><span class="line">    sapi_cgi_read_post,                /* read POST data */</span><br><span class="line">    sapi_cgi_read_cookies,            /* read Cookies */</span><br><span class="line"></span><br><span class="line">    sapi_cgi_register_variables,    /* register server variables */</span><br><span class="line">    sapi_cgi_log_message,            /* Log message */</span><br><span class="line">    NULL,                            /* Get request time */</span><br><span class="line">    NULL,                            /* Child terminate */</span><br><span class="line"></span><br><span class="line">    STANDARD_SAPI_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>定义了一些常量字符串，以及定义初始化函数、销毁函数、以及一些函数指针，告诉Zend如何获取与输出数据。</p>
<p><strong>例如：php_cgi_startup 调用php初始化。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static int php_cgi_startup(sapi_module_struct *sapi_module)</span><br><span class="line">&#123;</span><br><span class="line">    if (php_module_startup(sapi_module, &amp;cgi_module_entry, 1) == FAILURE) &#123;</span><br><span class="line">        return FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">    return SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>例如：php_module_shutdown_wrapper php关闭函数。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 int php_module_shutdown_wrapper(sapi_module_struct *sapi_globals)</span><br><span class="line">2 &#123;</span><br><span class="line">3     php_module_shutdown();</span><br><span class="line">4     return SUCCESS;</span><br><span class="line">5 &#125;</span><br></pre></td></tr></table></figure>
<p><strong>例如：sapi_cgi_activate 处理request进行初始化。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">static int sapi_cgi_activate(void)</span><br><span class="line">&#123;</span><br><span class="line">    char *path, *doc_root, *server_name;</span><br><span class="line">    size_t path_len, doc_root_len, server_name_len;</span><br><span class="line"></span><br><span class="line">    /* PATH_TRANSLATED should be defined at this stage but better safe than sorry :) */</span><br><span class="line">    if (!SG(request_info).path_translated) &#123;</span><br><span class="line">        return FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (php_ini_has_per_host_config()) &#123;</span><br><span class="line">        /* Activate per-host-system-configuration defined in php.ini and stored into configuration_hash during startup */</span><br><span class="line">        if (fcgi_is_fastcgi()) &#123;</span><br><span class="line">            fcgi_request *request = (fcgi_request*) SG(server_context);</span><br><span class="line"></span><br><span class="line">            server_name = FCGI_GETENV(request, &quot;SERVER_NAME&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            server_name = getenv(&quot;SERVER_NAME&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        /* SERVER_NAME should also be defined at this stage..but better check it anyway */</span><br><span class="line">        if (server_name) &#123;</span><br><span class="line">            server_name_len = strlen(server_name);</span><br><span class="line">            server_name = estrndup(server_name, server_name_len);</span><br><span class="line">            zend_str_tolower(server_name, server_name_len);</span><br><span class="line">            php_ini_activate_per_host_config(server_name, server_name_len);</span><br><span class="line">            efree(server_name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (php_ini_has_per_dir_config() ||</span><br><span class="line">        (PG(user_ini_filename) &amp;&amp; *PG(user_ini_filename))</span><br><span class="line">    ) &#123;</span><br><span class="line">        /* Prepare search path */</span><br><span class="line">        path_len = strlen(SG(request_info).path_translated);</span><br><span class="line"></span><br><span class="line">        /* Make sure we have trailing slash! */</span><br><span class="line">        if (!IS_SLASH(SG(request_info).path_translated[path_len])) &#123;</span><br><span class="line">            path = emalloc(path_len + 2);</span><br><span class="line">            memcpy(path, SG(request_info).path_translated, path_len + 1);</span><br><span class="line">            path_len = zend_dirname(path, path_len);</span><br><span class="line">            path[path_len++] = DEFAULT_SLASH;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            path = estrndup(SG(request_info).path_translated, path_len);</span><br><span class="line">            path_len = zend_dirname(path, path_len);</span><br><span class="line">        &#125;</span><br><span class="line">        path[path_len] = 0;</span><br><span class="line"></span><br><span class="line">        /* Activate per-dir-system-configuration defined in php.ini and stored into configuration_hash during startup */</span><br><span class="line">        php_ini_activate_per_dir_config(path, path_len); /* Note: for global settings sake we check from root to path */</span><br><span class="line"></span><br><span class="line">        /* Load and activate user ini files in path starting from DOCUMENT_ROOT */</span><br><span class="line">        if (PG(user_ini_filename) &amp;&amp; *PG(user_ini_filename)) &#123;</span><br><span class="line">            if (fcgi_is_fastcgi()) &#123;</span><br><span class="line">                fcgi_request *request = (fcgi_request*) SG(server_context);</span><br><span class="line"></span><br><span class="line">                doc_root = FCGI_GETENV(request, &quot;DOCUMENT_ROOT&quot;);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                doc_root = getenv(&quot;DOCUMENT_ROOT&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            /* DOCUMENT_ROOT should also be defined at this stage..but better check it anyway */</span><br><span class="line">            if (doc_root) &#123;</span><br><span class="line">                doc_root_len = strlen(doc_root);</span><br><span class="line">                if (doc_root_len &gt; 0 &amp;&amp; IS_SLASH(doc_root[doc_root_len - 1])) &#123;</span><br><span class="line">                    --doc_root_len;</span><br><span class="line">                &#125;</span><br><span class="line">#ifdef PHP_WIN32</span><br><span class="line">                /* paths on windows should be case-insensitive */</span><br><span class="line">                doc_root = estrndup(doc_root, doc_root_len);</span><br><span class="line">                zend_str_tolower(doc_root, doc_root_len);</span><br><span class="line">#endif</span><br><span class="line">                php_cgi_ini_activate_user_config(path, path_len, doc_root, doc_root_len, (doc_root_len &gt; 0 &amp;&amp; (doc_root_len - 1)));</span><br><span class="line"></span><br><span class="line">#ifdef PHP_WIN32</span><br><span class="line">                efree(doc_root);</span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        efree(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>例如：sapi_cgi_deactivate 处理完request关闭函数，与activate对应。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int sapi_cgi_deactivate(void)</span><br><span class="line">&#123;</span><br><span class="line">    /* flush only when SAPI was started. The reasons are:</span><br><span class="line">        1. SAPI Deactivate is called from two places: module init and request shutdown</span><br><span class="line">        2. When the first call occurs and the request is not set up, flush fails on FastCGI.</span><br><span class="line">    */</span><br><span class="line">    if (SG(sapi_started)) &#123;</span><br><span class="line">        if (fcgi_is_fastcgi()) &#123;</span><br><span class="line">            if (</span><br><span class="line">                !parent &amp;&amp;</span><br><span class="line">                !fcgi_finish_request((fcgi_request*)SG(server_context), 0)) &#123;</span><br><span class="line">                php_handle_aborted_connection();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            sapi_cgi_flush(SG(server_context));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>