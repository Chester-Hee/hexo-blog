<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="code farmer."><title>拒绝服务攻击防范-Nginx | 追赶日落日出</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?66bdd0a984d281716c78a567d1f39e67";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">首页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Nginx/">Nginx</a></div><div class="post-time">2018-04-30</div></div></div><div class="container post-header"><h1>拒绝服务攻击防范-Nginx</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过Web服务器检查拒绝"><span class="toc-number">1.</span> <span class="toc-text">通过Web服务器检查拒绝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过代码进行拦截过滤"><span class="toc-number">2.</span> <span class="toc-text">通过代码进行拦截过滤</span></a></li></ol></details></div><div class="container post-content"><p>一个网站性能有限，如果有人恶意去频繁对页面进行刷新，其实对服务器影响是很大的，导致资源使用非常高，直接影响到其他用户的体验。<br>那么对于这样的一些频繁访问，我们该如何去拒绝它呢？<br>我总结了两种方法：第一种方式通过<strong>Web服务器检查拒绝</strong>，第二种方式通过<strong>代码进行拦截过滤</strong>。</p>
<h3 id="通过Web服务器检查拒绝"><a href="#通过Web服务器检查拒绝" class="headerlink" title="通过Web服务器检查拒绝"></a>通过Web服务器检查拒绝</h3><p>第一种方式大致原理和思路是这样的，比如我们的Web服务器采用Nginx，那个Nginx可以记录用户访问记录，并通过查询分析这个日志可以得出频繁访问用户IP列表。</p>
<p>我们需要做的事情：<br>做一个定时任务，定时去分析日志文件，将得到的频繁访问用户的IP，并将IP设置到Nginx配置文件中的IP黑名单中，然后进行reload配置文件，当IP类表较大时，可以更新到iptables中去。</p>
<p>日志文件，查询IP的访问次数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">grep &apos;202.154.216.155&apos; 2017-12-03.access.log|wc -l</span><br><span class="line">289</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">curl ipinfo.io/202.154.216.155;echo&apos;&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;ip&quot;: &quot;202.154.216.155&quot;,</span><br><span class="line">  &quot;hostname&quot;: &quot;fr.07.gs&quot;,</span><br><span class="line">  &quot;city&quot;: &quot;&quot;,</span><br><span class="line">  &quot;region&quot;: &quot;&quot;,</span><br><span class="line">  &quot;country&quot;: &quot;ZH&quot;,</span><br><span class="line">  &quot;loc&quot;: &quot;112.8600,3.3500&quot;,</span><br><span class="line">  &quot;org&quot;: &quot;AS12876 ONLINE S.A.S.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在 Nginx 上，所以可以使用 Nginx 的 Deny 来拒绝攻击者的IP访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">deny 195.154.211.220;</span><br><span class="line">deny 195.154.188.28;</span><br><span class="line">deny 195.154.188.186;</span><br><span class="line">deny 180.97.106.161;</span><br><span class="line">deny 180.97.106.162;</span><br><span class="line">deny 180.97.106.36;</span><br></pre></td></tr></table></figure>
<h3 id="通过代码进行拦截过滤"><a href="#通过代码进行拦截过滤" class="headerlink" title="通过代码进行拦截过滤"></a>通过代码进行拦截过滤</h3><p>具体做法是，在拦截器/过滤器中做一个计数器，如果单位时间内访问同一个资源或接口的次数超过安全阈值，则进行403拒绝访问返回。</p>
<blockquote>
<p>实践更能检验代码</p>
</blockquote>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>