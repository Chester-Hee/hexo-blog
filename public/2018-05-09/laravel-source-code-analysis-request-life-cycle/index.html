<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="code farmer."><title>Laravel 源码分析之请求的生命周期 | 追赶日落日出</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?66bdd0a984d281716c78a567d1f39e67";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">首页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Laravel/">Laravel</a></div><div class="post-time">2018-05-09</div></div></div><div class="container post-header"><h1>Laravel 源码分析之请求的生命周期</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Laravel-源码分析之请求生命周期"><span class="toc-number">1.</span> <span class="toc-text">Laravel 源码分析之请求生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#生命周期"><span class="toc-number">1.1.</span> <span class="toc-text">生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#入口文件-创建Application实例"><span class="toc-number">1.1.1.</span> <span class="toc-text">入口文件-创建Application实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP内核"><span class="toc-number">1.1.2.</span> <span class="toc-text">HTTP内核</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Bootstrap-启动项"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">Bootstrap 启动项</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pipeline-管道处理请求"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">Pipeline 管道处理请求</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#入口文件，返回http头部-Body"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">入口文件，返回http头部+Body</span></a></li></ol></li></ol></li></ol></li></ol></details></div><div class="container post-content"><h2 id="Laravel-源码分析之请求生命周期"><a href="#Laravel-源码分析之请求生命周期" class="headerlink" title="Laravel 源码分析之请求生命周期"></a>Laravel 源码分析之请求生命周期</h2><p>引用一句话，告诉我为什么做这件事：<br>“在日常生活中使用任何工具时，如果理解了该工具的工作原理，使用时能更加运用自如。这对于应用开发来说也一样，当你能真正懂得一个功能背后实现原理时，你就离成为大神不远了”</p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>对于Web服务的每一个请求，都有一个响应的过程，直到客户端收到通知。整个接受请求和处理请求并响应的过程，我称之为生命周期。</p>
<h4 id="入口文件-创建Application实例"><a href="#入口文件-创建Application实例" class="headerlink" title="入口文件-创建Application实例"></a>入口文件-创建Application实例</h4><p>这个是所有请求的开始，我们很容易在<code>nginx</code>配置中看到这样的片段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location ~ ^/.*$ &#123;</span><br><span class="line">    fastcgi_index index.php;</span><br><span class="line">    fastcgi_param SCRIPT_FILENAME $document_root/index.php;</span><br><span class="line">    fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 index.php 就是我们的入口文件，这个文件一般完成非常简单的工作。</p>
<p>在Laravel的入口文件中，首先完成两个工作</p>
<ul>
<li>1.文件加载 Composer 生成定义的自动加载器</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>2.bootstrap/app.php 脚本中检索 Laravel 应用程序的实例</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br></pre></td></tr></table></figure>
<p>Laravel 本身采取的第一个动作是创建一个 application/ service container 的实例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</span><br><span class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>创建 application 实例，操作三步初始化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册完成基础绑定</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;registerBaseBindings();</span><br><span class="line"><span class="comment">// 注册基础Provider 事件，日志，路由</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;registerBaseServiceProviders();</span><br><span class="line"><span class="comment">// 注册核心容器的别名访问</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;registerCoreContainerAliases();</span><br></pre></td></tr></table></figure>
<h4 id="HTTP内核"><a href="#HTTP内核" class="headerlink" title="HTTP内核"></a>HTTP内核</h4><p>Laravel 中所有的Web请求都会经过HTTP内核进行处理（这里我们不关注console），入口文件完成HTTP内核实例化，并将请求抛给内核进行处理。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>对上面代码做一个分析。</p>
<ul>
<li>实例化kernel，<code>Illuminate\Contracts\Http\Kernel::class</code> 的实现类在 <code>Illuminate\Foundation\Http\Kernel</code></li>
<li><code>capture()</code> 这方法捕获所有请求参数，并返回一个Request对象</li>
<li>入口文件，只负责将请求抛给handle，并不关心路由，配置，错误异常等问题。HTTP 内核的 <code>handle</code> 方法的方法签名非常简单：接收 <code>Request</code> 并返回 <code>Response</code> 可以把内核当作是代表整个应用程序的<code>大黑盒</code>，给它 HTTP 请求，它就返回 HTTP 响应。</li>
</ul>
<p>内核Kernel <code>handle</code> 完成了什么工作呢？我们去探究一番！</p>
<h5 id="Bootstrap-启动项"><a href="#Bootstrap-启动项" class="headerlink" title="Bootstrap 启动项"></a>Bootstrap 启动项</h5><p>内核首先调用系统启动 <code>$this-&gt;bootstrap()</code>，这里会完成六项工作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $bootstrappers = [</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\LoadConfiguration::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\HandleExceptions::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\RegisterFacades::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\RegisterProviders::class,</span><br><span class="line">    \Illuminate\Foundation\Bootstrap\BootProviders::class,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<ul>
<li><code>LoadEnvironmentVariables::class</code>  执行.env环境配置文件读取</li>
<li><code>LoadConfiguration::class</code> 加载config/*.php配置文件，绑定config实例依赖注入</li>
<li><p><code>HandleExceptions::class</code> 异常状态的捕获处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(<span class="number">-1</span>);</span><br><span class="line">set_error_handler([<span class="keyword">$this</span>, <span class="string">'handleError'</span>]);</span><br><span class="line">set_exception_handler([<span class="keyword">$this</span>, <span class="string">'handleException'</span>]);</span><br><span class="line">register_shutdown_function([<span class="keyword">$this</span>, <span class="string">'handleShutdown'</span>]);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>RegisterFacades::class</code> 注册初始化门面Facade</p>
</li>
<li><code>RegisterProviders::class</code> 从配置app.php文件，完成provider注册，可以理解调用register()函数</li>
<li><code>BootProviders::class</code> 从配置app.php文件，完成provider注册，可以理解调用boot()函数</li>
</ul>
<p>从上面流程可以看出，所有的provider boot() 都是在register() 之后的。</p>
<h5 id="Pipeline-管道处理请求"><a href="#Pipeline-管道处理请求" class="headerlink" title="Pipeline 管道处理请求"></a>Pipeline 管道处理请求</h5><p><code>Router</code>根据用户请求参数，获取执行的<code>回调函数</code>或者<code>Controller</code>，并得到<code>Response</code>。<br>将Response交给pipeline进行处理，pipeline会对配置的中间件进行递归，滤后的<code>Response</code>进行返回</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</span><br><span class="line">    -&gt;send($request)</span><br><span class="line">    -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</span><br><span class="line">    -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</span><br></pre></td></tr></table></figure>
<h5 id="入口文件，返回http头部-Body"><a href="#入口文件，返回http头部-Body" class="headerlink" title="入口文件，返回http头部+Body"></a>入口文件，返回http头部+Body</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line"><span class="comment">// send() 方法主要实现下面两个动作</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;sendHeaders();</span><br><span class="line"><span class="keyword">$this</span>-&gt;sendContent();</span><br></pre></td></tr></table></figure>
<p><code>$this-&gt;sendContent()</code>  其实就是 echo $this-&gt;content;</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>