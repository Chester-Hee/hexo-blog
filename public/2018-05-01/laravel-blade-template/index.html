<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="code farmer."><title>Laravel Blade 模板 | 追赶日落日出</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?66bdd0a984d281716c78a567d1f39e67";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">首页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Laravel/">Laravel</a></div><div class="post-time">2018-05-01</div></div></div><div class="container post-header"><h1>Laravel Blade 模板</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Laravel-Blade-模板引擎"><span class="toc-number">1.</span> <span class="toc-text">Laravel-Blade 模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#简介"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Blade-Engine原理"><span class="toc-number">1.2.</span> <span class="toc-text">Blade-Engine原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#代码执行流程"><span class="toc-number">1.2.1.</span> <span class="toc-text">代码执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#view-gt-render"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">$view-&gt;render()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#engine-gt-get"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">$engine-&gt;get()</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#token-get-all"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">token_get_all()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#模板继承与区块"><span class="toc-number">1.2.2.</span> <span class="toc-text">模板继承与区块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#显示数据"><span class="toc-number">1.2.3.</span> <span class="toc-text">显示数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#控制结构"><span class="toc-number">1.2.4.</span> <span class="toc-text">控制结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#子视图"><span class="toc-number">1.3.</span> <span class="toc-text">子视图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩充-Blade"><span class="toc-number">1.4.</span> <span class="toc-text">扩充 Blade</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="Laravel-Blade-模板引擎"><a href="#Laravel-Blade-模板引擎" class="headerlink" title="Laravel-Blade 模板引擎"></a>Laravel-Blade 模板引擎</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Blade 是Laravel所提供的一个简单并且强大的模板引擎，视图文件以<code>.blade</code> 做为扩展名，通常保存在views文件夹中</p>
<h3 id="Blade-Engine原理"><a href="#Blade-Engine原理" class="headerlink" title="Blade-Engine原理"></a>Blade-Engine原理</h3><p>Laravel是基于服务容器的，模板引擎也不例外，在上一篇Laravel源码分析文章中，初始化<code>注册核心容器的别名访问</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;registerCoreContainerAliases();</span><br><span class="line"></span><br><span class="line"><span class="string">'view'</span>  =&gt; [<span class="string">'Illuminate\View\Factory'</span>, <span class="string">'Illuminate\Contracts\View\Factory'</span>],</span><br></pre></td></tr></table></figure>
<p>我们首先了解一下源码结构，可以简单得出类的依赖关系，<code>View</code>依赖于<code>Engines</code>，<code>Engines</code>依赖于<code>Compilers</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">├── Compilers</span><br><span class="line">│   ├── BladeCompiler.php</span><br><span class="line">│   ├── CompilerInterface.php</span><br><span class="line">│   └── Compiler.php</span><br><span class="line">├── composer.json</span><br><span class="line">├── Engines</span><br><span class="line">│   ├── CompilerEngine.php</span><br><span class="line">│   ├── EngineInterface.php</span><br><span class="line">│   ├── Engine.php</span><br><span class="line">│   ├── EngineResolver.php</span><br><span class="line">│   └── PhpEngine.php</span><br><span class="line">├── Expression.php</span><br><span class="line">├── Factory.php</span><br><span class="line">├── FileViewFinder.php</span><br><span class="line">├── Middleware</span><br><span class="line">│   └── ShareErrorsFromSession.php</span><br><span class="line">├── ViewFinderInterface.php</span><br><span class="line">├── View.php</span><br><span class="line">└── ViewServiceProvider.php</span><br></pre></td></tr></table></figure>
<h4 id="代码执行流程"><a href="#代码执行流程" class="headerlink" title="代码执行流程"></a>代码执行流程</h4><p>执行流程分解<code>return view(&#39;index&#39;);</code></p>
<h5 id="view-gt-render"><a href="#view-gt-render" class="headerlink" title="$view-&gt;render()"></a>$view-&gt;render()</h5><p>这里将engine当做<code>黑盒</code>，传入文件以及参数，得到contents内容.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;engine-&gt;get(<span class="keyword">$this</span>-&gt;path, <span class="keyword">$this</span>-&gt;gatherData());</span><br></pre></td></tr></table></figure>
<h5 id="engine-gt-get"><a href="#engine-gt-get" class="headerlink" title="$engine-&gt;get()"></a>$engine-&gt;get()</h5><p>这里会根据view文件名称生成对应的MD5缓存文件，如果文件发生更新，对应缓存文件也会刷新<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($path, array $data = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;compiler-&gt;isExpired($path)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;compiler-&gt;compile($path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $compiled = <span class="keyword">$this</span>-&gt;compiler-&gt;getCompiledPath($path);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="token-get-all"><a href="#token-get-all" class="headerlink" title="token_get_all()"></a>token_get_all()</h5><p>模板引擎核心是使用<code>token_get_all()</code>语法分析器，这个函数返回语法分析结果数组，遍历返回数组，得到类型为<code>T_INLINE_HTML</code>数据，并对其进行Blade编译。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $compilers = [</span><br><span class="line">    <span class="string">'Extensions'</span>,</span><br><span class="line">    <span class="string">'Statements'</span>,</span><br><span class="line">    <span class="string">'Comments'</span>,</span><br><span class="line">    <span class="string">'Echos'</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- Extensions对应的是的自定义Blade扩展标签，最后会用到。</span><br><span class="line">- Statements是最重点的一个，包括所有@开头的标签，如`@<span class="keyword">include</span>`,`@extends`,`@<span class="keyword">foreach</span>`</span><br><span class="line">- Comments是编译注解的</span><br><span class="line">- Echos是编译`&#123;&#123;`,`&#123;!!`,`&#123;&#123;&#123;`这几种输出方式的，下午也会介绍如何使用</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">compileString</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;footer = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (token_get_all($value) <span class="keyword">as</span> $token) &#123;</span><br><span class="line">        $result .= is_array($token) ? <span class="keyword">$this</span>-&gt;parseToken($token) : $token;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $result. = array_reverse(<span class="keyword">$this</span>-&gt;footer);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="模板继承与区块"><a href="#模板继承与区块" class="headerlink" title="模板继承与区块"></a>模板继承与区块</h4><p>源代码实现继承原理其实并不复杂，使用用户级别的输出缓冲区<code>ob_start</code></p>
<p>Blade 的两个最大优点就是<code>模板继承</code>与<code>区块</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">`@section` 命令定义一个内容区块，而 `@<span class="keyword">yield</span>` 命令被用来 “显示指定区块” 的内容</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;应用程序名称 - @<span class="keyword">yield</span>(<span class="string">'title'</span>)&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        @section(<span class="string">'sidebar'</span>)</span><br><span class="line">            这是主要的侧边栏。</span><br><span class="line">        @show</span><br><span class="line"></span><br><span class="line">        &lt;div class="container"&gt;</span><br><span class="line">            @<span class="keyword">yield</span>(<span class="string">'content'</span>)</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>继承页面布局</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@extends(<span class="string">'layouts.master'</span>)</span><br><span class="line"></span><br><span class="line">@section(<span class="string">'title'</span>, <span class="string">'页面标题'</span>)</span><br><span class="line"></span><br><span class="line">@section(<span class="string">'sidebar'</span>)</span><br><span class="line">    @<span class="keyword">parent</span></span><br><span class="line"></span><br><span class="line">    &lt;p&gt;这边会附加在主要的侧边栏。&lt;/p&gt;</span><br><span class="line">@endsection</span><br><span class="line"></span><br><span class="line">@section(<span class="string">'content'</span>)</span><br><span class="line">    &lt;p&gt;这是我的主要内容。&lt;/p&gt;</span><br><span class="line">@endsection</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在这个例子中，sidebar 区块利用了 @<span class="keyword">parent</span> 命令增加（而不是覆盖）内容至布局的侧边栏。@<span class="keyword">parent</span> 命令会在视图输出时被置换成布局的内容</span><br></pre></td></tr></table></figure>
<h4 id="显示数据"><a href="#显示数据" class="headerlink" title="显示数据"></a>显示数据</h4><p>你可以像这样显示 name 变量的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Hello, &#123;&#123; $name &#125;&#125;.</span><br><span class="line"></span><br><span class="line">注意：`Blade` 的 `&#123;&#123; &#125;&#125;` 语法会自动调用 `PHP htmlentites` 函数来防御 XSS 攻击。</span><br><span class="line"></span><br><span class="line">由于许多 JavaScript 框架也使用「大括号」在浏览器中显示指定的表达式，因此可以使用 @ 符号来告知 Blade 渲染引擎该表达式应该维持原样。举个例子：</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Laravel&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">Hello, @&#123;&#123; name &#125;&#125;.</span><br></pre></td></tr></table></figure>
<h4 id="控制结构"><a href="#控制结构" class="headerlink" title="控制结构"></a>控制结构</h4><p>判断</p>
<p>你可以使用 <code>@if</code>、<code>@elseif</code>、<code>@else</code> 及 <code>@endif</code> 命令建构 if 表达式。这些命令的功能等同于在 PHP 中的语法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">if</span> (count($records) === <span class="number">1</span>)</span><br><span class="line">    我有一条记录！</span><br><span class="line">@<span class="keyword">elseif</span> (count($records) &gt; <span class="number">1</span>)</span><br><span class="line">    我有多条记录！</span><br><span class="line">@<span class="keyword">else</span></span><br><span class="line">    我没有任何记录！</span><br><span class="line">@<span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<p>循环</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">10</span>; $i++)</span><br><span class="line">    目前的值为 &#123;&#123; $i &#125;&#125;</span><br><span class="line">@<span class="keyword">endfor</span></span><br><span class="line"></span><br><span class="line">@<span class="keyword">foreach</span> ($users <span class="keyword">as</span> $user)</span><br><span class="line">    &lt;p&gt;此用户为 &#123;&#123; $user-&gt;id &#125;&#125;&lt;/p&gt;</span><br><span class="line">@<span class="keyword">endforeach</span></span><br><span class="line"></span><br><span class="line">@forelse ($users <span class="keyword">as</span> $user)</span><br><span class="line">    &lt;li&gt;&#123;&#123; $user-&gt;name &#125;&#125;&lt;/li&gt;</span><br><span class="line">@<span class="keyword">empty</span></span><br><span class="line">    &lt;p&gt;没有用户&lt;/p&gt;</span><br><span class="line">@endforelse</span><br></pre></td></tr></table></figure>
<h3 id="子视图"><a href="#子视图" class="headerlink" title="子视图"></a>子视图</h3><p>Blade 的 <code>@include</code> 命令用来引入已存在的视图，所有在父视图的可用变量在被引入的视图中都是可用的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">include</span>(<span class="string">'view.name'</span>, [<span class="string">'some'</span> =&gt; <span class="string">'data'</span>])</span><br></pre></td></tr></table></figure>
<h3 id="扩充-Blade"><a href="#扩充-Blade" class="headerlink" title="扩充 Blade"></a>扩充 Blade</h3><p>Blade 甚至允许你自定义命令，你可以使用 <code>directive</code> 方法注册命令。当 Blade 编译器遇到该命令时，它将会带参数调用提供的回调函数。</p>
<p>以下例子会创建一个把指定的 <code>$var</code> 格式化的 <code>@datetime($var)</code> 命令：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 运行服务注册后的启动进程。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Blade::directive(<span class="string">'datetime'</span>, <span class="function"><span class="keyword">function</span><span class="params">($expression)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;?php echo with&#123;$expression&#125;-&gt;format('m/d/Y H:i'); ?&gt;"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如你所见，Laravel 的 with 辅助函数被用在这个命令中。with 辅助函数会简单地返回指定的对象或值，并允许使用便利的链式调用。最后此命令生成的 PHP 会是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> with($var)-&gt;format(<span class="string">'m/d/Y H:i'</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>