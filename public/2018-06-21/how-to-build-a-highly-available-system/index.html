<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="code farmer."><title>如何建设高可用系统 | 追赶日落日出</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?66bdd0a984d281716c78a567d1f39e67";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">首页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/高可用/">高可用</a></div><div class="post-time">2018-06-21</div></div></div><div class="container post-header"><h1>如何建设高可用系统</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#高可用性设计建议"><span class="toc-number">1.</span> <span class="toc-text">高可用性设计建议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#减少单点"><span class="toc-number">1.0.1.</span> <span class="toc-text">减少单点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#减少依赖"><span class="toc-number">1.0.2.</span> <span class="toc-text">减少依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#限制循环"><span class="toc-number">1.0.3.</span> <span class="toc-text">限制循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#控制流量"><span class="toc-number">1.0.4.</span> <span class="toc-text">控制流量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#精准监控"><span class="toc-number">1.0.5.</span> <span class="toc-text">精准监控</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#无状态"><span class="toc-number">1.0.6.</span> <span class="toc-text">无状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#容量规划"><span class="toc-number">1.0.7.</span> <span class="toc-text">容量规划</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#功能开关"><span class="toc-number">1.0.8.</span> <span class="toc-text">功能开关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置超时"><span class="toc-number">1.0.9.</span> <span class="toc-text">设置超时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重试策略"><span class="toc-number">1.0.10.</span> <span class="toc-text">重试策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#隔离"><span class="toc-number">1.0.11.</span> <span class="toc-text">隔离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异步调用"><span class="toc-number">1.0.12.</span> <span class="toc-text">异步调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#热点缓存"><span class="toc-number">1.0.13.</span> <span class="toc-text">热点缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#缓存容灾"><span class="toc-number">1.0.14.</span> <span class="toc-text">缓存容灾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分级缓存"><span class="toc-number">1.0.15.</span> <span class="toc-text">分级缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#系统分级"><span class="toc-number">1.0.16.</span> <span class="toc-text">系统分级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务降级"><span class="toc-number">1.0.17.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#流量蓄洪"><span class="toc-number">1.0.18.</span> <span class="toc-text">流量蓄洪</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务权重"><span class="toc-number">1.0.19.</span> <span class="toc-text">服务权重</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#依赖简化"><span class="toc-number">1.0.20.</span> <span class="toc-text">依赖简化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#弹性扩容"><span class="toc-number">1.0.21.</span> <span class="toc-text">弹性扩容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#灰度和回滚"><span class="toc-number">1.0.22.</span> <span class="toc-text">灰度和回滚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#减少远程调用"><span class="toc-number">1.0.23.</span> <span class="toc-text">减少远程调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#熔断机制"><span class="toc-number">1.0.24.</span> <span class="toc-text">熔断机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#运行时加载模块"><span class="toc-number">1.0.25.</span> <span class="toc-text">运行时加载模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码扫描"><span class="toc-number">1.0.26.</span> <span class="toc-text">代码扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自动备份"><span class="toc-number">1.0.27.</span> <span class="toc-text">自动备份</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线上压测"><span class="toc-number">1.0.28.</span> <span class="toc-text">线上压测</span></a></li></ol></li></ol></details></div><div class="container post-content"><h2 id="高可用性设计建议"><a href="#高可用性设计建议" class="headerlink" title="高可用性设计建议"></a>高可用性设计建议</h2><p>“高可用性”（High Availability）通常来描述一个系统经过专门的设计，从而减少停工时间，而保持其服务的高度可用性。以下是高可用系统的设计建议：</p>
<h4 id="减少单点"><a href="#减少单点" class="headerlink" title="减少单点"></a>减少单点</h4><p>去单点首先要识别整个系统所有主链路的单点，如机房（同城异地双机房），应用服务器，DNS服务器，SFTP服务器，LBS，缓存服务器，数据库，消息服务器，代理服务器和专线等，如系统通过专线调用对方服务，需要考虑同时拉联通和电信的专线，联通或电信的专线还是有一定概率会出现问题的，但是同时出问题的概率会小非常多。优先使用软负载，使用硬负载兜底。</p>
<h4 id="减少依赖"><a href="#减少依赖" class="headerlink" title="减少依赖"></a>减少依赖</h4><p>减少DNS依赖，减少远程服务依赖，DNS依赖可以尝试设置本地host，用工具给所有服务器推送最新的域名映射关系，通过本地缓存或近端服务减少RPC调用。</p>
<h4 id="限制循环"><a href="#限制循环" class="headerlink" title="限制循环"></a>限制循环</h4><p>避免无限死循环，导致CPU利用率百分百，可以设置for循环的最大循环次数，如最大循环1000次。</p>
<h4 id="控制流量"><a href="#控制流量" class="headerlink" title="控制流量"></a>控制流量</h4><p>避免异常流量对应用服务器产生影响，可以对指定服务设置流量限制，如QPS，TPS，QPH（每小时总请求量）和QPD（每天总请求量）。</p>
<h4 id="精准监控"><a href="#精准监控" class="headerlink" title="精准监控"></a>精准监控</h4><p>对CPU利用率，load，内存，带宽，系统调用量，应用错误量，PV，UV和业务量进行监控，避免内存泄露和异常代码对系统产生影响，配置监控一定要精准，如平时内存利用率是50%，监控可以配置成60%进行报警，这样可以提前感知内存泄露问题，避免应用无响应。</p>
<h4 id="无状态"><a href="#无状态" class="headerlink" title="无状态"></a>无状态</h4><p>服务器不能保存用户状态数据，如在集群环境下不能用static变量保存用户数据，不能长时间把用户文件存放在服务器本地。服务器有状态会难以扩容，且出现单点问题。</p>
<h4 id="容量规划"><a href="#容量规划" class="headerlink" title="容量规划"></a>容量规划</h4><p>定期对容量进行评估。如大促前进行压测和容量预估，根据需要进行扩容。</p>
<h4 id="功能开关"><a href="#功能开关" class="headerlink" title="功能开关"></a>功能开关</h4><p>打开和关闭某些功能，比如消息量过大，系统处理不了，把开关打开后直接丢弃消息不处理。上线新功能增加开关，如果有问题关闭新功能。</p>
<h4 id="设置超时"><a href="#设置超时" class="headerlink" title="设置超时"></a>设置超时</h4><p>设置连接超时和读超时设置，不应该太大，如果是内部调用连接超时可以设置成1秒，读超时3秒，外部系统调用连接超时可以设置成3秒，读超时设置成20秒。</p>
<h4 id="重试策略"><a href="#重试策略" class="headerlink" title="重试策略"></a>重试策略</h4><p>当调用外部服务异常时可以设置重试策略，每次重试时间递增，但是需要设置最大重试次数和重试开关，避免对下游系统产生影响。</p>
<h4 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h4><p>应用隔离，模块隔离，机房隔离和线程池隔离。可以按照优先级，不变和变几个维度来隔离应用和模块，如抽象和不变的代码放在一个模块，这个模块的代码几乎不会修改，可用性高，经常变的业务逻辑放在一个模块里，这样就算有问题，也只会影响到某一个业务。不同的业务使用不同的线程池，避免低优先级任务阻塞高优先级，或高优先级任务过多时影响低优先级任务永远不会执行。 </p>
<h4 id="异步调用"><a href="#异步调用" class="headerlink" title="异步调用"></a>异步调用</h4><p>同步调用改成异步调用，解决远程调用故障或调用超时对系统的影响。</p>
<h4 id="热点缓存"><a href="#热点缓存" class="headerlink" title="热点缓存"></a>热点缓存</h4><p>对热点数据进行缓存，降低RPC调用。如B系统提供名单服务，B系统可以提供一个client SDK提供近端缓存服务，定期去服务器端取数据，减少RPC调用。</p>
<h4 id="缓存容灾"><a href="#缓存容灾" class="headerlink" title="缓存容灾"></a>缓存容灾</h4><p>当数据库不可用时可以使用缓存的数据。并设置分级缓存，如优先读本地缓存，其次读分布式缓存。</p>
<h4 id="分级缓存"><a href="#分级缓存" class="headerlink" title="分级缓存"></a>分级缓存</h4><p>优先读本地缓存，其次读分布式缓存。通过推模式更新本地缓存。</p>
<h4 id="系统分级"><a href="#系统分级" class="headerlink" title="系统分级"></a>系统分级</h4><p>对系统进行分级，如ABC三个等级，高级别系统不依赖于低级别系统，并且高级别系统比底级别系统高可用率要高。</p>
<h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><p>如果系统出现响应缓慢等状况，可以关闭部分功能，从而释放系统资源，保证核心服务的正常运行。需要识别哪些服务可以降级，比如突然有大量消息流入，导致服务不可用，我们会把消息直接丢弃掉。或通过设置流控，拒绝为低级别系统提供服务。</p>
<h4 id="流量蓄洪"><a href="#流量蓄洪" class="headerlink" title="流量蓄洪"></a>流量蓄洪</h4><p>当流量陡增时，可以将请求进行蓄洪，如把请求保存在数据库中，再按照指定的QPS进行泄洪，有效的保护下游系统，也保证了服务的可用性。当调用对方系统，对方系统响应缓慢或无响应时，可采取自动蓄洪。</p>
<h4 id="服务权重"><a href="#服务权重" class="headerlink" title="服务权重"></a>服务权重</h4><p>在集群环境中，可自动识别高性能服务，拒绝调用性能低的服务。如在集群环境中，对调用超时的服务器进行权重降低，优先调用权重高的服务器。</p>
<h4 id="依赖简化"><a href="#依赖简化" class="headerlink" title="依赖简化"></a>依赖简化</h4><p>减少系统之间的依赖，比如使用消息驱动，A和B系统通过消息服务器传递数据，A和B系统使用数据库进行读写分离，A系统负责往数据库中写数据，B系统负责读数据，因为数据存放在数据库中，当A不可用时，短时间内不影响B系统提供服务。</p>
<h4 id="弹性扩容"><a href="#弹性扩容" class="headerlink" title="弹性扩容"></a>弹性扩容</h4><p>根据资源的使用率自动或手动进行扩容。如带宽不够用时，快速增加带宽。</p>
<h4 id="灰度和回滚"><a href="#灰度和回滚" class="headerlink" title="灰度和回滚"></a>灰度和回滚</h4><p>发布新功能只让部分服务器生效，且观察几天逐渐切流，如果出现问题只影响部分客户。出现问题快速回滚，或者直接下线灰度的机器。</p>
<h4 id="减少远程调用"><a href="#减少远程调用" class="headerlink" title="减少远程调用"></a>减少远程调用</h4><p>优先调用本地JVM内服务，其次是同机房服务，然后是同城服务，最后是跨城服务。如A调用B，B调用互联网的C系统获取数据，B系统可以把数据缓存起来，并设置数据的保鲜度，减少B对C的依赖。配置中心把注册服务的地址推送到调用服务的系统本地。参数中心把参数配置信息推送到系统的本地内存，而不是让系统去远程服务器获取参数信息。</p>
<h4 id="熔断机制"><a href="#熔断机制" class="headerlink" title="熔断机制"></a>熔断机制</h4><p>增加熔断机制，当监控出线上数据出现大幅跌涨时，及时中断，避免对业务产生更大影响。如我们做指标计算时，指标可以计算慢，但是不能算错，如果发现某个用户的指标环比或同比增长一倍或跌零，会考虑保存所有消息，并中止该用户的指标计算。</p>
<h4 id="运行时加载模块"><a href="#运行时加载模块" class="headerlink" title="运行时加载模块"></a>运行时加载模块</h4><p>我们会把经常变的业务代码变成一个个业务模块，使用Java的ClassLoader在运行时动态加载和卸载模块，当某个模块有问题时候，可以快速修复。</p>
<h4 id="代码扫描"><a href="#代码扫描" class="headerlink" title="代码扫描"></a>代码扫描</h4><p>使用IDEA代码分析等工具进行代码扫描，识别出程序中的BUG，如空指针异常，循环依赖等。</p>
<h4 id="自动备份"><a href="#自动备份" class="headerlink" title="自动备份"></a>自动备份</h4><p>程序，系统配置和数据定期进行备份。可使用linux命令和shell脚本定时执行备份策略，自动进行本地或异地。出现问题时能快速重新部署。</p>
<h4 id="线上压测"><a href="#线上压测" class="headerlink" title="线上压测"></a>线上压测</h4><p>系统的对外服务需要进行压测，知道该服务能承受的QPS和TPS，从而做出相对准确的限流。</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>