<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="code farmer."><title>Laravel-Admin 用户与权限 | 追赶日落日出</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?66bdd0a984d281716c78a567d1f39e67";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">首页</a><a class="sidebar-nav-item" href="/archives">归档</a><a class="sidebar-nav-item" href="/about">关于我</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Laravel/">Laravel</a></div><div class="post-time">2018-04-27</div></div></div><div class="container post-header"><h1>Laravel-Admin 用户与权限</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">Table of Contents</summary><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Laravel-Admin-用户与权限"><span class="toc-number">1.</span> <span class="toc-text">Laravel-Admin 用户与权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LA-权限数据库设计方案"><span class="toc-number">1.0.1.</span> <span class="toc-text">LA 权限数据库设计方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LA-权限控制方式"><span class="toc-number">1.1.</span> <span class="toc-text">LA 权限控制方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#路由控制"><span class="toc-number">1.1.1.</span> <span class="toc-text">路由控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#页面控制"><span class="toc-number">1.1.2.</span> <span class="toc-text">页面控制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#场景1"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">场景1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#场景2"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">场景2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#中间件控制"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">中间件控制</span></a></li></ol></li></ol></li></ol></details></div><div class="container post-content"><h2 id="Laravel-Admin-用户与权限"><a href="#Laravel-Admin-用户与权限" class="headerlink" title="Laravel-Admin 用户与权限"></a>Laravel-Admin 用户与权限</h2><p>LA 不仅给我们提供快速构建<code>表单</code> <code>表格</code> <code>Tree</code> 工具，还提供一套完善的权限管理方案。</p>
<h4 id="LA-权限数据库设计方案"><a href="#LA-权限数据库设计方案" class="headerlink" title="LA 权限数据库设计方案"></a>LA 权限数据库设计方案</h4><p>我简单画了一张实体关系图</p>
<p><img src="/images/pasted-30.png" alt="upload successful"></p>
<p>LA 权限设计中，使用三个实体<code>用户</code> <code>权限</code> <code>角色</code> ，它们之间都是多对多对应关系。<br>所以，对应的数据库表设计图</p>
<p><img src="/images/pasted-31.png" alt="upload successful"></p>
<h3 id="LA-权限控制方式"><a href="#LA-权限控制方式" class="headerlink" title="LA 权限控制方式"></a>LA 权限控制方式</h3><p>对于权限的控制访问，LA 给出了多种方式</p>
<h4 id="路由控制"><a href="#路由控制" class="headerlink" title="路由控制"></a>路由控制</h4><p>在laravel-admin 1.5中，权限和路由是绑定在一起的，在编辑权限页面里面设置当前权限能访问的路由，在HTTP方法select框中选择访问路由的方法，在HTTP路径textarea中填写能访问的路径。</p>
<p>比如要添加一个权限，该权限可以以GET方式访问路径/admin/users，那么HTTP方法选择GET，HTTP路径填写/users。</p>
<p>我们来分析一下源代码 Middleware\Permission.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Request $request, \Closure $next)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 如果用户未登录，直接跳过（跳过是让登录验证中间件进行处理）</span></span><br><span class="line">        <span class="keyword">if</span> (!Admin::user()) &#123;</span><br><span class="line">            <span class="keyword">return</span> $next($request);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断用户是否存在此权限，若存在允许访问，否则返回异常</span></span><br><span class="line">        <span class="keyword">if</span> (!Admin::user()-&gt;allPermissions()-&gt;first(<span class="function"><span class="keyword">function</span> <span class="params">($permission)</span> <span class="title">use</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $permission-&gt;shouldPassThrough($request);</span><br><span class="line">        &#125;)) &#123;</span><br><span class="line">            AuthPermission::error();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里要解释一下权限项是什么，LA中的一个权限项，包含三个部分<code>权限标识</code> <code>请求方式集合</code> <code>请求路径集合</code></p>
<p>权限标识 = hello<br>请求方式集合 = [‘GET’, ‘POST’] = 支持GET/POST<br>请求路径集合 = [‘/admin/logs’,’/admin/users’] = 允许访问 logs/users 路径</p>
<p><img src="/images/pasted-32.png" alt="upload successful"></p>
<p>Admin::user()-&gt;allPermissions() // 获取所有权限<br>具体实现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">allPermissions</span><span class="params">()</span> : <span class="title">Collection</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 这里实现思路是，获取 用户角色对应权限 并集 当前用户权限</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;roles()-&gt;with(<span class="string">'permissions'</span>)-&gt;get()-&gt;pluck(<span class="string">'permissions'</span>)-&gt;flatten()-&gt;merge(<span class="keyword">$this</span>-&gt;permissions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="页面控制"><a href="#页面控制" class="headerlink" title="页面控制"></a>页面控制</h4><h5 id="场景1"><a href="#场景1" class="headerlink" title="场景1"></a>场景1</h5><p>比如现在有一个场景，对文章发布模块做权限管理，以创建文章为例</p>
<p>首先创建一项权限，进入/admin/auth/permissions，权限标识（slug）填写create-post，权限名称填写创建文章，这样权限就创建好了。 第二步可以把这个权限直接附加给个人或者角色，在用户编辑页面可以直接把上面创建好的权限附加给当前编辑用户，也可以在编辑角色页面附加给某个角色。 第三步，在创建文章控制器里面添加控制代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">Encore</span>\<span class="title">Admin</span>\<span class="title">Auth</span>\<span class="title">Permission</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 检查权限，有create-post权限的用户或者角色可以访问创建文章页面</span></span><br><span class="line">        Permission::check(<span class="string">'create-post'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="场景2"><a href="#场景2" class="headerlink" title="场景2"></a>场景2</h5><p>如果你要在表格中控制用户对元素的显示，那么需要先定义两个权限，比如权限标示delete-image、和view-title-column分别用来控制有删除图片的权限和显示某一列的权限，把这两个权限赋给你设置的角色，然后在grid中加入代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$grid-&gt;actions(<span class="function"><span class="keyword">function</span> <span class="params">($actions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 没有`delete-image`权限的角色不显示删除按钮</span></span><br><span class="line">    <span class="keyword">if</span> (!Admin::user()-&gt;can(<span class="string">'delete-image'</span>)) &#123;</span><br><span class="line">        $actions-&gt;disableDelete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有具有`view-title-column`权限的用户才能显示`title`这一列</span></span><br><span class="line"><span class="keyword">if</span> (Admin::user()-&gt;can(<span class="string">'view-title-column'</span>)) &#123;</span><br><span class="line">    $grid-&gt;column(<span class="string">'title'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在blade模板中，可以这样使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@<span class="keyword">if</span>(Admin::user()-&gt;can(<span class="string">'set'</span>))</span><br><span class="line">    <span class="comment">// 修改系统变量</span></span><br><span class="line">@<span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<h5 id="中间件控制"><a href="#中间件控制" class="headerlink" title="中间件控制"></a>中间件控制</h5><p>可以在路由配置上结合权限中间件来控制路由的权限</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 允许administrator、editor两个角色访问group里面的路由</span></span><br><span class="line">Route::group([</span><br><span class="line">    <span class="string">'middleware'</span> =&gt; <span class="string">'admin.permission:allow,administrator,editor'</span>,</span><br><span class="line">], <span class="function"><span class="keyword">function</span> <span class="params">($router)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    $router-&gt;resource(<span class="string">'users'</span>, UserController::class);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>这篇博客部分摘要LA文档，如果你想了解更多，可以阅读源码！！！</p>
</div></div><div class="post-main post-comment"></div></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>